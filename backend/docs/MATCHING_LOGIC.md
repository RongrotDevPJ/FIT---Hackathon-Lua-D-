# üîÑ MATCHING_LOGIC.md

## üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á Matching & Negotiation

‡∏£‡∏∞‡∏ö‡∏ö LonganLink ‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠:

- ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà **‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏≥‡πÑ‡∏¢‡∏Ç‡∏≤‡∏¢ (Order Sell)**  
  ‡∏Å‡∏±‡∏ö  
  **‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡∏≥‡πÑ‡∏¢ (Order Buy)**
- ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏Å‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤
- ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏¥‡πâ‡∏á‡∏•‡∏≥‡πÑ‡∏¢ (Food Loss / Waste) ‡πÇ‡∏î‡∏¢‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

Matching Logic ‡∏à‡∏∞‡πÉ‡∏ä‡πâ **‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (province)** ‡πÅ‡∏•‡∏∞ **‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (amphoe)** ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏•‡∏±‡∏Å  
‡∏™‡πà‡∏ß‡∏ô Negotiation Logic ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ ‚Äú‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‚Äì‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‚Äù ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö

---

## üß± ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Matching

‡∏°‡∏µ entity ‡∏´‡∏•‡∏±‡∏Å ‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö Matching ‡πÅ‡∏•‡∏∞ Negotiation ‡∏Ñ‡∏∑‡∏≠:

### 1. Users
- `id`
- `name`
- `role` (`farmer` / `factory` / `admin`)
- `province`
- `amphoe`
- `phone`

### 2. Orders
‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á **Order Sell (‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£)** ‡πÅ‡∏•‡∏∞ **Order Buy (‡∏ù‡∏±‡πà‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô)**

- `id`
- `type` ‚Üí `"sell"` ‡∏´‡∏£‡∏∑‡∏≠ `"buy"`
- `ownerId` ‚Üí ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á order (users.id)
- `province`, `amphoe`
- `grade`
- `amountKg`
- `requestedPrice`
- `quota` (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö `type = "buy"`)
- `status` ‚Üí `"open"`, `"matched"`, `"closed"`

### 3. Negotiations
‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• **‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤** ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£

- `id`
- `orderId`
- `fromId`, `toId`
- `status` ‚Üí `"pending"`, `"accepted"`, `"rejected"`, `"counter"`
- `requestedPrice` ‚Üí ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠
- `finalPrice` ‚Üí ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏î‡∏µ‡∏•)
- `updatedAt`

---

## üß≠ Matching Logic ‚Äì ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°

### ‡πÄ‡∏Ñ‡∏™ A: ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏°‡∏≠‡∏á‡∏´‡∏≤‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ (Factory ‚Üí Find Sell Orders)

1. ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (role = `factory`)
2. Backend ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å collection `users`:
   - ‡∏î‡∏∂‡∏á `province` ‡πÅ‡∏•‡∏∞ `amphoe` ‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô
3. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ `orders` ‡∏ó‡∏µ‡πà:
   - `type = "sell"`
   - `status = "open"`
   - `province` ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô
4. ‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏£‡∏ì‡∏µ:
   - **Priority 1**: ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí `amphoe` ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô  
   - **Priority 2**: ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ô‡∏•‡∏∞‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
5. ‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≤‡∏° `requestedPrice` ‡∏´‡∏£‡∏∑‡∏≠ `amountKg`)
6. ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ frontend ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

#### Pseudo-code:

```ts
// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô
const user = await getUser(factoryId);

const sameAmphoe = await db.collection('orders')
  .where('type', '==', 'sell')
  .where('status', '==', 'open')
  .where('province', '==', user.province)
  .where('amphoe', '==', user.amphoe)
  .get();

const sameProvince = await db.collection('orders')
  .where('type', '==', 'sell')
  .where('status', '==', 'open')
  .where('province', '==', user.province)
  .get();

// ‡∏£‡∏ß‡∏°‡∏ú‡∏•: ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
const results = [...sameAmphoeDocs, ...filteredSameProvinceButOtherAmphoe];
